---
title: ä»£ç†æ¨¡å¼
date: 2017-04-19 12ï¼š57
tags: ['è®¾è®¡æ¨¡å¼', 'JavaScript']
categories: è®¾è®¡æ¨¡å¼
---

æœ€è¿‘ç¦»èŒåœ¨å®¶ï¼Œé—²äº†å¥½å‡ å¤©ï¼Œå¤ä¹ ä¸€ä¸‹ä»£ç†æ¨¡å¼ã€‚

<!-- more -->

## å®šä¹‰

ç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶æœ‰ä»£ç†å¯¹è±¡æ§åˆ¶åŸå¯¹è±¡çš„å¼•ç”¨ã€‚å±äºç»“æ„å‹æ¨¡å¼ã€‚

## ç»“æ„

### UML ç±»å›¾

![](https://design-patterns.readthedocs.io/zh_CN/latest/_images/Proxy.jpg)



ç”±ä¸Šå›¾å¯ä»¥åˆ†æå‡ºæ„é€ ä¸€ä¸ªä»£ç†æ¨¡å¼éœ€è¦ä¸‰ä¸ªç±»ï¼š

- Subjectï¼šæŠ½è±¡ç±»ï¼›
- Proxyï¼šä»£ç†ç±»ï¼›
- RealSubjectï¼šå®é™…ç±»ï¼›



```javascript
class Subject {
  constructor () {}
  
  request () {
    console.error('è¯·é‡å†™ request æ–¹æ³•ï¼')
  }
}

class Proxy extends Subject {
  constructor () {
    super()
  }
  
  afterRequest () {}
  
  beforeRequest () {}
  
  request () {}
}

class RealSubject extends Subject {
  constructor () {
    super()
  }
  
  request () {}
}
```

### æ—¶åºå›¾

![](https://design-patterns.readthedocs.io/zh_CN/latest/_images/seq_Proxy.jpg)

é€šè¿‡æ—¶åºå›¾ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ° ç”¨æˆ·ï¼ˆ:Clientï¼‰æ˜¯ç›´æ¥äº¤äº’ `Proxy` ç±»çš„å®ä¾‹çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æŒ‰ç…§æ—¶åºå›¾ä¸­çš„ 1.0 - 1.5 é¡ºåºå»å…·ä½“å®ç° UML å›¾çš„ä¸‰ä¸ªç±»ã€‚

```javascript
class Subject {
  constructor () {}
  
  request () {
    console.error('è¯·é‡å†™ request æ–¹æ³•ï¼')
  }
}

class Proxy extends Subject {
  constructor () {
    super()
    this.realSubject = new RealSubject()
  }
  
  afterRequest () {
    console.log('request end')
  }
  
  beforeRequest () {
    console.log('request start')
  }
  
  request () {
    this.beforeRequest()
    this.realSubject.request()
    this.afterRequest()
  }
}

class RealSubject extends Subject {
  constructor () {
    super()
  }
  
  request () {
    console.log('requesting')
  }
}

let proxy = new Proxy()
proxy.request()

// "request start"
// "requesting"
// "request end"
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸€ä¸ª ä»£ç†æ¨¡å¼å•¦ ğŸ™ƒ

å½“ç„¶å®é™…é¡¹ç›®ä¸­å¯èƒ½æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œä¹Ÿè®¸åœ¨è®¿é—®çœŸå®å¯¹è±¡ä¹‹å‰éœ€è¦å‘é€ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ æˆ–è€… çœŸå®å¯¹è±¡çš„è¯·æ±‚æ˜¯ä¸ªå¼‚æ­¥å¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±éœ€è¦åŠ ä¸Šä¸€äº›å¼‚æ­¥å¤„ç†äº†ã€‚

```javascript
class Proxy extends Subject {
  constructor () {
    super()
    this.realSubject = new RealSubject()
  }
  
  afterRequest () {
    console.log('request end')
  }
  
  beforeRequest () {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        console.log('request start, sleep 1000')
        resolve()
      }, 1000)
    })
  }
  
  request () {
    (async function (_this) {
      await _this.beforeRequest()
      await _this.realSubject.request()
      await _this.afterRequest()
    })(this)
  }
}
```

è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå…·ä½“çš„å®ç°ä¾æ®ä¸šåŠ¡å®é™…çš„éœ€æ±‚è¿›è¡Œæ”¹å†™ã€‚

## å›¾ç‰‡æ‡’åŠ è½½

web ä¸Šå¯¹äºä»£ç†æ¨¡å¼çš„å®ç°ï¼Œæ‡’åŠ è½½æ˜¯æœ€å¥½çš„ä½“ç°äº†ã€‚

```javascript
class ImgSubject {
	constructor (node, imgUrl) {
      	this.node = node
        this.imgUrl = imgUrl
    }
    request () {
        console.error('è¯·é‡å†™ request æ–¹æ³•')
    }
}

class RealImgSubject extends ImgSubject {
    constructor (node, imgUrl) {
        super(node, imgUrl)
    }

    request () {
        this.node.src = this.imgUrl
        console.log(this.node.src)
    }
}

class ImgProxy extends ImgSubject {
    constructor (node, imgUrl, loadSrc) {
        super(node, imgUrl)
        this.loadSrc = loadSrc
        this.realImg = new RealImgSubject(node, imgUrl)
    }

    beforeRequest () {
        // å…ˆåŠ è½½è¾ƒå°çš„ loading å›¾ç‰‡
        this.node.src = this.loadSrc
        return new Promise((resolve, reject) => {
            let fakeImgNode = document.createElement('img')
            fakeImgNode.src = this.imgUrl
            fakeImgNode.onload = () => {
                resolve()
            }
        })
    }

    afterRequest () {
        console.log('å…¶å®æ²¡æˆ‘ä»€ä¹ˆäº‹...')
    }
    request () {
        (async function (_this) {
            await _this.beforeRequest()
            await _this.realImg.request()
            await _this.afterRequest()
        })(this)
    }
}

let node = document.querySelector('#testImg')
let proxy = new ImgProxy(
    node,
    'https://www.google.com/logos/doodles/2017/esther-afua-ocloos-98th-birthday-5995813305057280-l.png',
    'http://img.lanrentuku.com/img/allimg/1212/5-121204193Q8.gif'
)
console.log(proxy)
proxy.request()
```

ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç®€å•çš„å›¾ç‰‡æ‡’åŠ è½½çš„å®ç°ã€‚å½“ç„¶ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯æ˜¯éå¸¸å¤šçš„ã€‚ä»£ç†æ¨¡å¼çš„ä¼˜ç‚¹åœ¨äº

- ä»£ç†æ¨¡å¼èƒ½å¤Ÿåè°ƒè°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³» ç»Ÿçš„è€¦åˆåº¦ã€‚
- è¿œç¨‹ä»£ç†ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥è®¿é—®åœ¨è¿œç¨‹æœºå™¨ä¸Šçš„å¯¹è±¡ï¼Œè¿œç¨‹æœºå™¨ å¯èƒ½å…·æœ‰æ›´å¥½çš„è®¡ç®—æ€§èƒ½ä¸å¤„ç†é€Ÿåº¦ï¼Œå¯ä»¥å¿«é€Ÿå“åº”å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚
- è™šæ‹Ÿä»£ç†é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°å¯¹è±¡æ¥ä»£è¡¨ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œå¯ä»¥å‡å°‘ç³» ç»Ÿèµ„æºçš„æ¶ˆè€—ï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œä¼˜åŒ–å¹¶æé«˜è¿è¡Œé€Ÿåº¦ã€‚
- ä¿æŠ¤ä»£ç†å¯ä»¥æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„ä½¿ç”¨æƒé™ã€‚

ä»¥ä¸Šå°±æ˜¯æˆ‘å¯¹ä»£ç†æ¨¡å¼çš„å­¦ä¹ å•¦ ~ ğŸ˜

***

> [å›¾è§£ä»£ç†æ¨¡å¼](https://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/proxy.html#id12)

